<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
const yearGroups = [
  "Year 7", "Year 8", "Year 9", "Year 10", "Year 11",
  "Sixth Form", "Learning Support", "Behaviour Support"
];

const nameOnlyTables = ["Isolation", "On-Call", "Pastoral", "Cafeteria", "Food Truck", "Detention"];
const specialRowOverride = {
  "Learning Support_PERIOD 5": "Early Dismissal",
  "Behaviour Support_PERIOD 5": "Early Dismissal"
};

const periods = [
  "FORM", "PERIOD 1", "PERIOD 2", "BREAK", "PERIOD 3", "PERIOD 4", "LUNCH", "PERIOD 5"
];

const claimable = ["FORM", "PERIOD 1", "PERIOD 2", "PERIOD 3", "PERIOD 4", "PERIOD 5"];

const user = JSON.parse(localStorage.getItem("user"));
const session = localStorage.getItem("selectedSession");
const allClaims = JSON.parse(localStorage.getItem("claims") || "{}");

const sessionKey = `${session}`;
if (!user || !session) {
  window.location.href = "login.html";
}
document.getElementById("sessionDate").textContent = session;

if (!allClaims[sessionKey]) {
  allClaims[sessionKey] = {};
}

let selectedSlot = null;
let nameOnlyMode = false;

function renderTables() {
  const container = document.getElementById("tablesContainer");
  container.innerHTML = "";

  yearGroups.forEach(group => container.appendChild(createPeriodTable(group)));
  nameOnlyTables.forEach(name => container.appendChild(createNameOnlyTable(name)));
}

function createPeriodTable(group) {
  const table = document.createElement("table");
  const tbody = document.createElement("tbody");

  for (let i = 0; i < periods.length + 1; i++) {
    const row = document.createElement("tr");
    const label = document.createElement("td");
    const action = document.createElement("td");

    if (i === 0) {
      action.textContent = group;
      label.textContent = "";
    } else {
      const period = periods[i - 1];
      label.textContent = period;

      const slotKey = `${group}_${period}`;
      const slot = allClaims[sessionKey][slotKey];

      // Special override
      if (specialRowOverride[slotKey]) {
        action.textContent = specialRowOverride[slotKey];
      } else if (claimable.includes(period)) {
        if (slot) {
          action.innerHTML = `<div class="claim-info">${slot.name}<br>${slot.room || ""}<br>${slot.subject || ""}<br><button onclick="editClaim('${slotKey}')">Edit</button></div>`;
        } else {
          const btn = document.createElement("button");
          btn.textContent = "Claim";
          btn.className = "claim-btn";
          btn.onclick = () => openModal(slotKey, false);
          action.appendChild(btn);
        }
      } else {
        action.textContent = "-";
      }
    }

    row.appendChild(label);
    row.appendChild(action);
    tbody.appendChild(row);
  }

  table.appendChild(tbody);
  return table;
}

function createNameOnlyTable(name) {
  const periods = name === "Detention" ? ["LUNCH"] : ["BREAK", "LUNCH"];
  const table = document.createElement("table");
  const tbody = document.createElement("tbody");

  const row1 = document.createElement("tr");
  row1.innerHTML = `<td></td><td>${name}</td>`;
  tbody.appendChild(row1);

  periods.forEach(period => {
    const row = document.createElement("tr");
    const label = document.createElement("td");
    const action = document.createElement("td");

    label.textContent = period;
    const slotKey = `${name}_${period}`;
    const slot = allClaims[sessionKey][slotKey];

    if (slot) {
      action.innerHTML = `<div class="claim-info">${slot.name}<br><button onclick="editClaim('${slotKey}', true)">Edit</button></div>`;
    } else {
      const btn = document.createElement("button");
      btn.textContent = "Claim";
      btn.className = "claim-btn";
      btn.onclick = () => openModal(slotKey, true);
      action.appendChild(btn);
    }

    row.appendChild(label);
    row.appendChild(action);
    tbody.appendChild(row);
  });

  table.appendChild(tbody);
  return table;
}

function openModal(slotKey, isNameOnly) {
  selectedSlot = slotKey;
  nameOnlyMode = isNameOnly;

  document.getElementById("teacherName").value = user.username;
  document.getElementById("room").value = "";
  document.getElementById("subject").value = "";

  document.getElementById("room").style.display = isNameOnly ? "none" : "inline-block";
  document.getElementById("subject").style.display = isNameOnly ? "none" : "inline-block";

  document.getElementById("claimModal").classList.remove("hidden");
}

function editClaim(slotKey, isNameOnly = false) {
  selectedSlot = slotKey;
  nameOnlyMode = isNameOnly;
  const slot = allClaims[sessionKey][slotKey];

  document.getElementById("teacherName").value = slot.name;
  document.getElementById("room").value = slot.room || "";
  document.getElementById("subject").value = slot.subject || "";

  document.getElementById("room").style.display = isNameOnly ? "none" : "inline-block";
  document.getElementById("subject").style.display = isNameOnly ? "none" : "inline-block";

  document.getElementById("claimModal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("claimModal").classList.add("hidden");
}

function submitClaim() {
  const name = document.getElementById("teacherName").value.trim();
  const room = nameOnlyMode ? "" : document.getElementById("room").value.trim();
  const subject = nameOnlyMode ? "" : document.getElementById("subject").value.trim();

  if (!name) {
    alert("Name is required");
    return;
  }

  // Prevent duplicate claims by name in same period
  for (const key in allClaims[sessionKey]) {
    if (
      allClaims[sessionKey][key].name === name &&
      key.split("_")[1] === selectedSlot.split("_")[1] &&
      key !== selectedSlot
    ) {
      alert("You already claimed a slot for this period.");
      return;
    }
  }

  allClaims[sessionKey][selectedSlot] = { name, room, subject };
  localStorage.setItem("claims", JSON.stringify(allClaims));
  closeModal();
  renderTables();
}

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

function logout() {
  localStorage.removeItem("user");
  window.location.href = "login.html";
}

function exportToPDF() {
  const container = document.getElementById("tablesContainer");
  const opt = {
    margin: 0.5,
    filename: `ClaimSheet-${sessionKey}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  };
  html2pdf().from(container).set(opt).save();
}

renderTables();
</script>

