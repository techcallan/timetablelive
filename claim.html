<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Claim Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #121212;
      color: #eee;
    }
    h2, h3 {
      margin-top: 2rem;
    }
    table {
      border-collapse: collapse;
      margin: 1rem 0;
      width: 100%;
      max-width: 500px;
      border: 1px solid #aaa;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    .table-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .claim-btn {
      padding: 0.3rem 0.6rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .dark-mode .claim-btn {
      background-color: #3399ff;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      width: 300px;
    }
    .dark-mode .modal-content {
      background-color: #333;
      color: #fff;
    }
    .hidden { display: none; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar button {
      padding: 0.4rem 0.6rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h2>Claim Teaching Periods</h2>
    <div>
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>
  <h3>Session: <span id="sessionDate"></span></h3>

  <div class="table-wrapper" id="tablesContainer"></div>

  <!-- Modal -->
  <div class="modal hidden" id="claimModal">
    <div class="modal-content">
      <h3>Claim This Period</h3>
      <input type="text" id="teacherName" placeholder="Teacher Name"><br><br>
      <input type="text" id="room" placeholder="Room"><br><br>
      <input type="text" id="subject" placeholder="Subject"><br><br>
      <button onclick="submitClaim()">Claim</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <script>
    const yearGroups = [
      "Year 7", "Year 8", "Year 9", "Year 10", "Year 11",
      "Sixth Form", "Learning Support", "Behaviour Support",
      "Isolation", "On-Call", "Pastoral"
    ];

    const cafeteriaTables = ["Cafeteria", "Food Truck"];
    const singleTable = "Lunch Duty";

    const periods = [
      "FORM", "PERIOD 1", "PERIOD 2", "BREAK", "PERIOD 3", "PERIOD 4", "LUNCH", "PERIOD 5"
    ];

    const claimable = ["FORM", "PERIOD 1", "PERIOD 2", "PERIOD 3", "PERIOD 4", "PERIOD 5"];

    const user = JSON.parse(localStorage.getItem("user"));
    const session = localStorage.getItem("selectedSession");
    const allClaims = JSON.parse(localStorage.getItem("claims") || "{}");

    const sessionKey = `${session}`;
    if (!user || !session) {
      window.location.href = "login.html";
    }

    document.getElementById("sessionDate").textContent = session;

    if (!allClaims[sessionKey]) {
      allClaims[sessionKey] = {};
    }

    let selectedSlot = null;

    function renderTables() {
      const container = document.getElementById("tablesContainer");
      container.innerHTML = "";

      yearGroups.forEach(group => container.appendChild(createPeriodTable(group)));
      cafeteriaTables.forEach(table => container.appendChild(createBreakLunchTable(table)));
      container.appendChild(createLunchOnlyTable(singleTable));
    }

    function createPeriodTable(group) {
      const table = document.createElement("table");
      const tbody = document.createElement("tbody");

      for (let i = 0; i < periods.length + 1; i++) {
        const row = document.createElement("tr");

        const label = document.createElement("td");
        const action = document.createElement("td");

        if (i === 0) {
          action.textContent = group;
          label.textContent = "";
        } else {
          label.textContent = periods[i - 1];
          const slotKey = `${group}_${periods[i - 1]}`;
          const slot = allClaims[sessionKey][slotKey];

          if (claimable.includes(periods[i - 1])) {
            if (slot) {
              action.innerHTML = `<div class="claim-info">${slot.name}<br>${slot.room}<br>${slot.subject}<br><button onclick="editClaim('${slotKey}')">Edit</button></div>`;
            } else {
              const btn = document.createElement("button");
              btn.textContent = "Claim";
              btn.className = "claim-btn";
              btn.onclick = () => openModal(slotKey);
              action.appendChild(btn);
            }
          } else {
            action.textContent = "-";
          }
        }

        row.appendChild(label);
        row.appendChild(action);
        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      return table;
    }

    function createBreakLunchTable(name) {
      const table = document.createElement("table");
      const tbody = document.createElement("tbody");

      const row1 = document.createElement("tr");
      row1.innerHTML = `<td></td><td>${name}</td>`;
      tbody.appendChild(row1);

      ["BREAK", "LUNCH"].forEach(period => {
        const row = document.createElement("tr");
        const label = document.createElement("td");
        const action = document.createElement("td");

        label.textContent = period;
        const slotKey = `${name}_${period}`;
        const slot = allClaims[sessionKey][slotKey];

        if (slot) {
          action.innerHTML = `<div class="claim-info">${slot.name}<br>${slot.room}<br>${slot.subject}<br><button onclick="editClaim('${slotKey}')">Edit</button></div>`;
        } else {
          const btn = document.createElement("button");
          btn.textContent = "Claim";
          btn.className = "claim-btn";
          btn.onclick = () => openModal(slotKey);
          action.appendChild(btn);
        }

        row.appendChild(label);
        row.appendChild(action);
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      return table;
    }

    function createLunchOnlyTable(name) {
      const table = document.createElement("table");
      const tbody = document.createElement("tbody");

      const row1 = document.createElement("tr");
      row1.innerHTML = `<td></td><td>${name}</td>`;
      tbody.appendChild(row1);

      const row2 = document.createElement("tr");
      const label = document.createElement("td");
      const action = document.createElement("td");

      label.textContent = "LUNCH";
      const slotKey = `${name}_LUNCH`;
      const slot = allClaims[sessionKey][slotKey];

      if (slot) {
        action.innerHTML = `<div class="claim-info">${slot.name}<br>${slot.room}<br>${slot.subject}<br><button onclick="editClaim('${slotKey}')">Edit</button></div>`;
      } else {
        const btn = document.createElement("button");
        btn.textContent = "Claim";
        btn.className = "claim-btn";
        btn.onclick = () => openModal(slotKey);
        action.appendChild(btn);
      }

      row2.appendChild(label);
      row2.appendChild(action);
      tbody.appendChild(row2);

      table.appendChild(tbody);
      return table;
    }

    function openModal(slotKey) {
      selectedSlot = slotKey;
      document.getElementById("teacherName").value = user.username;
      document.getElementById("room").value = "";
      document.getElementById("subject").value = "";
      document.getElementById("claimModal").classList.remove("hidden");
    }

    function editClaim(slotKey) {
      selectedSlot = slotKey;
      const slot = allClaims[sessionKey][slotKey];
      document.getElementById("teacherName").value = slot.name;
      document.getElementById("room").value = slot.room;
      document.getElementById("subject").value = slot.subject;
      document.getElementById("claimModal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("claimModal").classList.add("hidden");
    }

    function submitClaim() {
      const name = document.getElementById("teacherName").value.trim();
      const room = document.getElementById("room").value.trim();
      const subject = document.getElementById("subject").value.trim();

      if (!name || !room || !subject) {
        alert("All fields required");
        return;
      }

      // Prevent duplicate claims by same user in same period
      for (const key in allClaims[sessionKey]) {
        if (
          allClaims[sessionKey][key].name === name &&
          key.split("_")[1] === selectedSlot.split("_")[1] &&
          key !== selectedSlot
        ) {
          alert("You already claimed a slot for this period.");
          return;
        }
      }

      allClaims[sessionKey][selectedSlot] = { name, room, subject };
      localStorage.setItem("claims", JSON.stringify(allClaims));
      closeModal();
      renderTables();
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    renderTables();
  </script>
</body>
</html>
